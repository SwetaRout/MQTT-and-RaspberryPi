# MQTT-and-RaspberryPi

For this assignment, you will require three Raspberry Pis (I will call them Raspberry Pi A, Raspberry Pi B, and Raspberry Pi C) and two computers/laptops (or one computer/laptop and one smart phone) with WiFi interfaces, three LEDs, a light dependent resistor (LDR), a potentiometer, and some general resisters.  First of all, you have to install an MQTT broker on laptop # 1. You can use any MQTT broker you like (for example, look at the following links: http://mosquitto.org/2013/01/mosquitto-debian-repository/, http://www.hivemq.com/try-out/). It is not making it mandatory to choose a particular broker because I want you to explore around and learn about features of various brokers. In your report, justify why you used the broker that you used. The only restriction is that for this assignment, you have to run the broker on laptop # 1, and not use some online broker (there are several such online brokers available as well for free). This deployment has 1 MQTT broker (the laptop # 1) and 4 MQTT clients, described below: 1. Raspberry Pi A (this will be publisher as well as subscriber) 2. Raspberry Pi B (this will only be subscriber) 3. Raspberry Pi C (this will be publisher as well as subscriber) 4. Laptop # 2 OR the smart phone (this will only be subscriber) Connect an LDR and a potentiometer to your Raspberry Pi A through an ADC (search online and you will see numerous projects describing how to connect an LDR and a potentiometer to Raspberry Pi). LDR is just a resistor whose resistance changes with the intensity of light. The potentiometer is basically a variable resister. There is a dial on the potentiometer, rotating which changes the resistance of the potentiometer. We will use the LDR to sense the amount of light, and turn an LED on and off based on the amount of light falling on the LDR. We will use the potentiometer to change the threshold at which the LED turns on. The Raspberry Pi A will sample the values of both LDR and potentiometer every 100 milliseconds. Every time it samples the values, it compares the values of both LDR and potentiometer with the previous most recent values of the LDR and potentiometer, respectively. If the difference of either the LDR or the potentiometer is beyond a certain threshold (you determine the appropriate threshold values), it publishes the LDR and potentiometer values to broker running on laptop # 1. The Raspberry Pi A will publish the values of the LDR to the topic "lightSensor" and of the potentiometer to the topic "threshold". Before posting the values of the potentiometer to the topic, you may have to scale them. Take a hypothetical example. Suppose when you sample values from your ADC connected to LDR, you might observe that your ADC outputs a minimum value of 10 and maximum value of 100 based on no light to very bright light. Whereas, when you sample values from the potentiometer, you might observe that your ADC outputs values in the range 90 to 250 based on where the dial on the potentiometer is. In this case, you might want to bring the values of ADC for potentiometer in the same range as that for LDR. This can be done in various ways. For example, you can normalize the ADC values of both LDR and potentiometer to lie between 0 and 1 before publishing. You can decide whichever method you like to use. You will shortly see that these values will be used by Raspberry Pi C to decide when to turn on or turn off an LED based on how much light is being sensed by the LDR connected to Raspberry Pi A. With this potentiometer we can basically control what intensity of the light should be there before the Raspberry Pi B turns off the LED. 
Note that to compare the value of LDR or potentiometer with its previous most recent values that the Raspberry Pi A had published to the broker, use the following approach: Your Raspberry Pi A should subscribe to both these topics "lightSensor" and "threshold". Every time a message gets posted to these topics, the Raspberry Pi A receives it back. In case the Raspberry Pi A loses the connection and the previous values, it can reconnect to the broker and receive a "retained message" with the latest values. To accomplish this, every time Raspberry Pi A publishes a message to the broker, it must set the retain flag to make sure that the broker retains the values. One more thing that Raspberry Pi A has to do is that in its connection message to the broker, it should include a lastwill message as a retained message with content "offline" to a topic "Status/RaspberryPiA". As soon as it connects to the broker, it should send a retained message to the topic “Status/RaspberryPiA" with content "online". This step will make sure that anyone who is subscribed to the topic "Status/RaspberryPiA " would know the status of the Raspberry Pi A, i.e., whether the Raspberry Pi A is online or offline. If the Raspberry Pi A does a graceful disconnect, it should still send a retained message to "Status/RaspberryPiA " with content "offline". Raspberry Pi C is also connected to the broker and is subscribed to both topics "lightSensor" and "threshold". Every time it receives a message from the broker from either of the topics "lightSensor" and/or "threshold", it compares the LDR value with the threshold and generates a binary result: if "lightSensor" value >= "threshold" value, then the result is "TurnOn" otherwise "TurnOff". (Note that based on how you connected your LDR and potentiometer to the Raspberry Pi A, the results of the comparison could be opposite. The goal is that when there is more light, then the result of the comparison done by Raspberry Pi C should be "Turnoff", otherwise "TurnOn"). The Raspberry Pi C then compares the result with the previous decision it sent to the broker. If the decision has changed, it publishes the updated decision on the broker implemented on the Laptop # 1 to topic "LightStatus". Note that, just like for Raspberry Pi A, instead of remembering the decision Raspberry Pi C sent to the broker the last time, it can just subscribe to the topic "LightStatus" and set the retain flag every time it sends a new decision to this topic. One more thing that Raspberry Pi C has to do (just like the Raspberry Pi A) is that in its connection message to the broker, it should include a lastwill message as retained message with content "offline" to the topic "Status/RaspberryPiC". As soon as it connects to the broker, it should send a retained message to the topic "Status/RaspberryPiC " with content "online". This step will make sure that anyone who is subscribed to the topic "Status/RaspberryPiC " should know the status of the Raspberry Pi C whether the Raspberry Pi C is online or offline. If the Raspberry Pi C does a graceful disconnect, it should still send a message to "Status/RaspberryPiC " with content "offline". The Raspberry Pi B should also connect to the broker and subscribe to the topic "LightStatus", "Status/RaspberryPiA ", and "Status/RaspberryPiC". The Raspberry Pi B should also have three LEDs connected to it: LED1, LED2, and LED3. If the Raspberry Pi B receives the message "TurnOff" from topic "LightStatus", it should turn the LED1 off. If the Raspberry Pi B receives the message "TurnOn" from the topic "LightStatus", it should turn LED1 on. LED2 and LED3 will show the status of Raspberry Pi A and Raspberry Pi C.  If Raspberry Pi B receives a message of "online" from topic "Status/RaspberryPiA ", it should turn the LED2 on. If Raspberry Pi B receives a message of "offline" from topic “Status/RaspberryPiA", it should turn the LED2 off. If Raspberry Pi B receives a message of "online" from topic "Status/RaspberryPiC", it should turn the LED3 on and based on the most recent value it has received 
from "LightStatus", it should turn LED1 on or off. If the topic "LightStatus" does not yet have any value published on it, then Raspberry Pi B won't get any message from this topic. In that case the LED1 should stay off. If Raspberry Pi B receives a message of "offline" from topic "Status/RaspberryPiC", it should turn the LED1 and LED3 off. Finally, your laptop # 2 or smartphone should be subscribed to all these topics: "lightSensor", threshold", "LightStatus", "Status/RaspberryPiA ", and "Status/RaspberryPiC " and should display the messages sent by the broker on these topics along with the timestamps. You will further keep a record on laptop # 2/smartphone when the LED1 was turned on and when it was turned off. For all messages, use QoS 2 (i.e., the highest possible quality of service). 
